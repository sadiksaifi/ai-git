name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build for macOS ARM64
        working-directory: apps/cli
        run: |
          bun run build --target bun-darwin-arm64
          test -f dist/ai-git || { echo "ERROR: dist/ai-git not found after build"; exit 1; }
          cd dist
          tar -czf ai-git-darwin-arm64.tar.gz ai-git

      - name: Build for macOS x64
        working-directory: apps/cli
        run: |
          bun run build --target bun-darwin-x64
          test -f dist/ai-git || { echo "ERROR: dist/ai-git not found after build"; exit 1; }
          cd dist
          tar -czf ai-git-darwin-x64.tar.gz ai-git

      - name: Build for Linux x64
        working-directory: apps/cli
        run: |
          bun run build --target bun-linux-x64
          test -f dist/ai-git || { echo "ERROR: dist/ai-git not found after build"; exit 1; }
          cd dist
          tar -czf ai-git-linux-x64.tar.gz ai-git

      - name: Build for Linux ARM64
        working-directory: apps/cli
        run: |
          bun run build --target bun-linux-arm64
          test -f dist/ai-git || { echo "ERROR: dist/ai-git not found after build"; exit 1; }
          cd dist
          tar -czf ai-git-linux-arm64.tar.gz ai-git

      - name: Build for Windows x64
        working-directory: apps/cli
        run: |
          bun run build --target bun-windows-x64
          test -f dist/ai-git.exe || { echo "ERROR: dist/ai-git.exe not found after build"; exit 1; }
          cd dist
          zip ai-git-windows-x64.zip ai-git.exe

      - name: Generate checksums
        working-directory: apps/cli/dist
        run: shasum -a 256 *.tar.gz *.zip > checksums.txt

      - name: Generate Changelog
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          config: cliff.toml
          args: --latest --strip header --github-repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.changelog.outputs.content }}
          generate_release_notes: false
          files: |
            apps/cli/dist/ai-git-darwin-arm64.tar.gz
            apps/cli/dist/ai-git-darwin-x64.tar.gz
            apps/cli/dist/ai-git-linux-x64.tar.gz
            apps/cli/dist/ai-git-linux-arm64.tar.gz
            apps/cli/dist/ai-git-windows-x64.zip
            apps/cli/dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Homebrew Tap
        uses: actions/checkout@v4
        with:
          repository: sadiksaifi/homebrew-tap
          token: ${{ secrets.TAP_PAT }}
          path: homebrew-tap

      - name: Update Homebrew Formula
        run: |
          VERSION=${{ github.ref_name }}

          URL_ARM64="https://github.com/${{ github.repository }}/releases/download/${VERSION}/ai-git-darwin-arm64.tar.gz"
          SHA256_ARM64=$(shasum -a 256 apps/cli/dist/ai-git-darwin-arm64.tar.gz | awk '{print $1}')

          URL_X64="https://github.com/${{ github.repository }}/releases/download/${VERSION}/ai-git-darwin-x64.tar.gz"
          SHA256_X64=$(shasum -a 256 apps/cli/dist/ai-git-darwin-x64.tar.gz | awk '{print $1}')

          echo "Updating Formula for version $VERSION..."

          cd homebrew-tap/Formula

          # Update Version
          sed -i "s|version \".*\"|version \"${VERSION#v}\"|" ai-git.rb

          # Update ARM64 (range: if arm? ... else)
          sed -i '/if Hardware::CPU.arm?/,/else/s|url ".*"|url "'$URL_ARM64'"|' ai-git.rb
          sed -i '/if Hardware::CPU.arm?/,/else/s|sha256 ".*"|sha256 "'$SHA256_ARM64'"|' ai-git.rb

          # Update X64 (range: else ... end)
          sed -i '/else/,/end/s|url ".*"|url "'$URL_X64'"|' ai-git.rb
          sed -i '/else/,/end/s|sha256 ".*"|sha256 "'$SHA256_X64'"|' ai-git.rb

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ai-git.rb

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "release: ai-git version ${VERSION}" -m "Release: https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
            git push origin main
          fi

  publish-npm:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install latest npm
        run: npm install -g npm@latest

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p /tmp/artifacts
          cd /tmp/artifacts
          gh release download "$VERSION" \
            -R ${{ github.repository }} \
            -p "ai-git-darwin-arm64.tar.gz" \
            -p "ai-git-darwin-x64.tar.gz" \
            -p "ai-git-linux-arm64.tar.gz" \
            -p "ai-git-linux-x64.tar.gz" \
            -p "ai-git-windows-x64.zip"

      - name: Place binaries in platform packages
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          # Extract and place each platform binary
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            mkdir -p "packages/npm/${platform}/bin"
            tar -xzf "/tmp/artifacts/ai-git-${platform}.tar.gz" -C "packages/npm/${platform}/bin"
            chmod +x "packages/npm/${platform}/bin/ai-git"
          done

          # Windows â€” verify binary is named ai-git.exe after extraction
          mkdir -p packages/npm/win32-x64/bin
          unzip -o /tmp/artifacts/ai-git-windows-x64.zip -d packages/npm/win32-x64/bin
          test -f packages/npm/win32-x64/bin/ai-git.exe || { echo "ERROR: ai-git.exe not found after extraction"; exit 1; }

          # Update all 0.0.0 versions (package version + optionalDependencies)
          for pkg in packages/npm/*/package.json; do
            sed -i "s/\"0.0.0\"/\"${VERSION}\"/g" "$pkg"
          done

      - name: Validate all packages (dry-run)
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-arm64 linux-x64 win32-x64; do
            echo "Validating @ai-git/${pkg}..."
            cd "packages/npm/${pkg}"
            npm publish --provenance --access public --dry-run
            cd "${{ github.workspace }}"
          done
          echo "Validating @ai-git/cli..."
          cd packages/npm/ai-git
          npm publish --provenance --access public --dry-run

      - name: Publish platform packages
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-arm64 linux-x64 win32-x64; do
            echo "Publishing @ai-git/${pkg}..."
            cd "packages/npm/${pkg}"
            npm publish --provenance --access public
            cd "${{ github.workspace }}"
          done

      - name: Publish main package (@ai-git/cli)
        working-directory: packages/npm/ai-git
        run: npm publish --provenance --access public
