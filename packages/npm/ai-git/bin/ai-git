#!/usr/bin/env node

const { execFileSync } = require("child_process");
const fs = require("fs");
const path = require("path");
const os = require("os");

const PLATFORMS = {
  darwin: { arm64: "@ai-git/darwin-arm64", x64: "@ai-git/darwin-x64" },
  linux: { arm64: "@ai-git/linux-arm64", x64: "@ai-git/linux-x64" },
  win32: { x64: "@ai-git/win32-x64" },
};

const platformPkgs = PLATFORMS[os.platform()];
if (!platformPkgs) {
  console.error(`ai-git: unsupported platform: ${os.platform()}-${os.arch()}`);
  process.exit(1);
}

const pkg = platformPkgs[os.arch()];
if (!pkg) {
  console.error(`ai-git: unsupported architecture: ${os.platform()}-${os.arch()}`);
  process.exit(1);
}

const ext = os.platform() === "win32" ? ".exe" : "";
const bin = path.join(
  path.dirname(require.resolve(`${pkg}/package.json`)),
  "bin",
  `ai-git${ext}`,
);

if (!fs.existsSync(bin)) {
  console.error(
    `ai-git: binary not found at ${bin}\n` +
    `The platform package (${pkg}) may not contain a binary yet.\n` +
    `Try reinstalling: npm install -g @ai-git/cli`
  );
  process.exit(1);
}

try {
  execFileSync(bin, process.argv.slice(2), { stdio: "inherit" });
} catch (e) {
  if (e && typeof e === "object" && "status" in e && e.status !== null) {
    process.exit(e.status);
  }
  throw e;
}
